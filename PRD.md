# 产品需求文档（PRD）
# 通用 Agent 框架 + 智能问题定位系统

**版本**: v1.0
**日期**: 2026-02-10
**状态**: MVP 规划

---

## 1. 产品概述

### 1.1 产品定位
构建一个**可扩展的通用 Agent 框架**，首个应用场景为**微服务分布式架构下的智能问题定位工具**。

### 1.2 核心价值
- **自动化问题定位流程**：将当前需要人工在多个模块间跳转的定位过程自动化
- **业务逻辑异常识别**：能够定位没有报错日志的业务逻辑问题
- **可扩展框架**：支持未来集成其他工具和应用场景
- **业务知识可配置**：客户可上传业务规范，系统自动适配不同业务场景

### 1.3 解决的痛点
- 微服务架构下问题定位需要跨多个服务和模块
- 业务逻辑异常难以通过日志直接发现
- 定位过程依赖人工经验，效率低下
- 不同业务场景需要不同的定位策略

---

## 2. 目标用户

### 2.1 用户角色
- **开发人员**：定位开发环境和测试环境问题
- **运维/SRE**：定位生产环境问题，保障系统稳定性
- **技术支持/客服**：处理客户反馈的问题，快速响应

### 2.2 用户特征
- 熟悉微服务架构和分布式系统
- 需要频繁进行问题定位和故障排查
- 希望提高问题定位效率，减少人工成本

---

## 3. 核心功能

### 3.1 通用 Agent 框架

#### 3.1.1 Agent 交互模式
- **混合式交互**：
  - Agent 自动执行大部分定位步骤
  - 关键决策点询问用户确认
  - 用户可配置是否需要询问（自动化程度可调）

#### 3.1.2 工具扩展机制
采用三层工具体系：

**层级 1：内置工具（Python 实现）**
- 日志分析工具
- 代码搜索工具
- 文件读写工具
- 基础 Shell 执行工具

**层级 2：MCP 扩展**
- 外部系统集成（监控系统、日志平台、数据库等）
- 第三方服务调用
- 客户自定义工具

**层级 3：Skill 扩展**
- 业务规范文档
- 特定场景的定位流程
- 领域知识库

#### 3.1.3 LLM 接口
- 支持 OpenAI compatible 通用接口
- 客户可自行添加和配置多个 LLM 模型
- 支持模型切换和选择

### 3.2 问题定位能力

#### 3.2.1 支持的问题类型
- 业务逻辑异常（无报错日志）
- 系统报错和异常
- 性能问题（接口响应慢、资源占用高）
- 数据不一致问题
- 间歇性故障

#### 3.2.2 定位流程
```
用户反馈/问题描述
    ↓
日志收集与分析
    ↓
调用链路追踪
    ↓
代码分析
    ↓
根因定位
    ↓
输出结论和建议
```

#### 3.2.3 业务知识配置
- 客户通过上传 **Skill 压缩包**提供业务信息
- Skill 包内容：
  - 业务规范文档
  - 日志格式说明
  - 服务拓扑关系
  - 业务流程图
  - 其他业务相关文件

#### 3.2.4 输出内容（可配置）
- 问题根因分析
- 涉及的服务和调用链路
- 相关代码位置
- 修复建议
- 置信度评分
- 相似历史问题推荐

### 3.3 多租户管理

#### 3.3.1 租户隔离
- 数据隔离：每个租户的数据独立存储
- 配置隔离：Skill、MCP、LLM 配置按租户管理
- 权限隔离：用户只能访问所属租户的资源

#### 3.3.2 用户权限
- 租户管理员：管理租户配置、用户权限
- 普通用户：使用问题定位功能
- 只读用户：查看历史记录和报告

### 3.4 历史记录与知识库

#### 3.4.1 历史定位记录
- 保存每次问题定位的完整过程
- 包含输入、分析步骤、输出结果
- 支持按时间、问题类型、服务等维度检索

#### 3.4.2 知识库积累
- 自动提取问题特征和解决方案
- 相似问题推荐
- 问题模式识别
- 知识库持续优化

---

## 4. 用户场景

### 4.1 场景 1：用户反馈功能异常
**场景描述**：用户反馈"订单提交失败"

**定位流程**：
1. 用户输入问题描述："用户 A 在 2026-02-10 10:30 提交订单失败"
2. Agent 自动收集相关日志（订单服务、支付服务、库存服务）
3. Agent 分析调用链路，发现库存服务返回异常
4. Agent 定位到库存服务代码，发现库存扣减逻辑错误
5. Agent 输出根因：库存扣减时未考虑并发场景，导致超卖
6. Agent 提供修复建议：添加分布式锁或使用数据库乐观锁

### 4.2 场景 2：性能问题定位
**场景描述**：某接口响应时间突然变慢

**定位流程**：
1. 用户输入："订单查询接口响应时间从 100ms 增加到 3s"
2. Agent 分析监控数据，发现数据库查询耗时增加
3. Agent 检查数据库慢查询日志
4. Agent 定位到未添加索引的查询语句
5. Agent 输出根因和优化建议

### 4.3 场景 3：业务逻辑异常
**场景描述**：优惠券计算结果不符合预期

**定位流程**：
1. 用户输入："用户 B 使用优惠券后价格计算错误"
2. Agent 读取业务规范（从 Skill 中获取优惠券计算规则）
3. Agent 分析相关代码和日志
4. Agent 发现优惠券叠加逻辑与业务规范不一致
5. Agent 输出根因和修复建议

---

## 5. 功能需求

### 5.1 Agent 框架核心功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| Agent 引擎 | 基于 LLM 的推理和决策引擎 | P0 |
| 工具注册 | 支持内置工具、MCP、Skill 的注册和调用 | P0 |
| 交互控制 | 支持自动执行和询问用户的混合模式 | P0 |
| LLM 管理 | 支持多 LLM 配置和切换 | P0 |
| 上下文管理 | 管理对话上下文和工具调用历史 | P0 |

### 5.2 问题定位功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 日志分析 | 解析和分析各类日志格式 | P0 |
| 代码搜索 | 在代码库中搜索相关代码 | P0 |
| 调用链追踪 | 分析服务间调用关系 | P1 |
| 根因分析 | 基于日志和代码推断问题根因 | P0 |
| 修复建议 | 提供可行的修复方案 | P1 |
| 业务规范匹配 | 根据业务规范验证逻辑正确性 | P1 |

### 5.3 系统管理功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 租户管理 | 创建、编辑、删除租户 | P0 |
| 用户管理 | 用户注册、登录、权限管理 | P0 |
| Skill 管理 | 上传、解析、管理 Skill 压缩包 | P0 |
| MCP 管理 | 配置和管理 MCP 服务器 | P1 |
| LLM 配置 | 配置和管理 LLM 接口 | P0 |
| 历史记录 | 查看和检索历史定位记录 | P0 |
| 知识库 | 查看和管理知识库内容 | P1 |

### 5.4 Web 界面功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 问题定位界面 | 输入问题描述，展示定位过程和结果 | P0 |
| 配置管理界面 | 管理 Skill、MCP、LLM 配置 | P0 |
| 历史记录界面 | 查看和检索历史记录 | P0 |
| 知识库界面 | 浏览和搜索知识库 | P1 |
| 系统设置界面 | 租户和用户管理 | P0 |

---

## 6. 非功能需求

### 6.1 性能要求
- 单次问题定位响应时间：< 30 秒（简单问题）
- 并发支持：支持 100+ 并发用户
- 历史记录查询：< 1 秒

### 6.2 可用性要求
- 系统可用性：99.5%
- 支持水平扩展

### 6.3 安全要求
- 租户数据隔离
- 用户认证和授权
- 敏感信息加密存储
- API 访问控制

### 6.4 可扩展性要求
- 支持动态加载 Skill 和 MCP
- 支持添加新的内置工具
- 支持多种 LLM 模型

### 6.5 易用性要求
- 界面简洁直观
- 问题定位过程可视化
- 支持自然语言输入

---

## 7. 技术架构

### 7.1 技术栈

**后端**
- 语言：Python 3.10+
- 框架：FastAPI
- 数据库：PostgreSQL（关系数据）+ Elasticsearch（日志和知识库）
- 缓存：Redis
- 任务队列：Celery

**前端**
- 框架：Vue 3
- UI 组件库：Element Plus / Ant Design Vue
- 状态管理：Pinia
- 构建工具：Vite

**LLM 接口**
- OpenAI compatible API
- 支持多模型配置

### 7.2 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      前端 (Vue3)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │问题定位  │  │配置管理  │  │历史记录  │  │知识库   │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                          │ HTTP/WebSocket
┌─────────────────────────────────────────────────────────┐
│                   API Gateway (FastAPI)                  │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼────────┐ ┌──────▼──────┐ ┌───────▼────────┐
│  Agent 引擎    │ │  系统管理   │ │  数据服务      │
│                │ │             │ │                │
│ - LLM 调用     │ │ - 租户管理  │ │ - 历史记录     │
│ - 工具调度     │ │ - 用户管理  │ │ - 知识库       │
│ - 上下文管理   │ │ - 权限控制  │ │ - 配置存储     │
└────────────────┘ └─────────────┘ └────────────────┘
        │
        ├─────────────────┬─────────────────┐
        │                 │                 │
┌───────▼────────┐ ┌──────▼──────┐ ┌───────▼────────┐
│  内置工具      │ │  MCP 扩展   │ │  Skill 扩展    │
│                │ │             │ │                │
│ - 日志分析     │ │ - 监控系统  │ │ - 业务规范     │
│ - 代码搜索     │ │ - 日志平台  │ │ - 定位流程     │
│ - 文件操作     │ │ - 数据库    │ │ - 知识库       │
└────────────────┘ └─────────────┘ └────────────────┘
        │
┌───────▼────────────────────────────────────────────────┐
│                    数据存储层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │PostgreSQL│  │Elasticsearch│ │  Redis   │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└────────────────────────────────────────────────────────┘
```

### 7.3 数据库设计（核心表）

**租户表 (tenants)**
- id, name, created_at, updated_at, status

**用户表 (users)**
- id, tenant_id, username, email, password_hash, role, created_at

**问题定位记录表 (diagnosis_records)**
- id, tenant_id, user_id, problem_description, input_data, output_data, status, created_at, updated_at

**知识库表 (knowledge_base)**
- id, tenant_id, problem_type, problem_pattern, solution, confidence_score, created_at

**Skill 配置表 (skills)**
- id, tenant_id, name, version, file_path, config, created_at

**MCP 配置表 (mcp_servers)**
- id, tenant_id, name, endpoint, config, created_at

**LLM 配置表 (llm_configs)**
- id, tenant_id, name, api_endpoint, api_key, model_name, is_default, created_at

---

## 8. MVP 范围

### 8.1 MVP 包含功能

**核心功能**
- ✅ Agent 框架（工具注册、调度、上下文管理）
- ✅ 内置工具（日志分析、代码搜索）
- ✅ Skill 扩展支持（上传、解析、加载）
- ✅ MCP 扩展支持（配置、调用）
- ✅ 问题定位完整流程
- ✅ 多租户管理
- ✅ 用户认证和权限
- ✅ 历史记录存储和查询
- ✅ 基础知识库功能

**Web 界面**
- ✅ 用户登录/注册
- ✅ 问题定位界面（输入、过程展示、结果展示）
- ✅ Skill 管理界面（上传、查看、删除）
- ✅ MCP 配置界面
- ✅ LLM 配置界面
- ✅ 历史记录查看

### 8.2 MVP 不包含功能（后续版本）

- 高级知识库功能（自动学习、模式识别）
- 调用链可视化
- 实时监控集成
- 移动端支持
- 多语言支持
- 高级权限管理（细粒度权限）

---

## 9. 项目里程碑

### Phase 1: 基础框架（4 周）
- Agent 引擎核心实现
- 工具注册和调度机制
- 基础 Web 框架搭建
- 数据库设计和实现

### Phase 2: 核心功能（4 周）
- 内置工具实现（日志分析、代码搜索）
- Skill 扩展机制
- MCP 扩展机制
- 问题定位流程实现

### Phase 3: 系统功能（3 周）
- 多租户管理
- 用户认证和权限
- 历史记录和知识库
- LLM 配置管理

### Phase 4: 前端开发（3 周）
- 问题定位界面
- 配置管理界面
- 历史记录界面
- 系统管理界面

### Phase 5: 测试和优化（2 周）
- 功能测试
- 性能优化
- 安全测试
- 文档编写

---

## 10. 风险和挑战

### 10.1 技术风险
- **LLM 推理准确性**：需要充分测试和优化 prompt
- **性能问题**：大规模日志分析可能耗时较长
- **工具扩展复杂度**：MCP 和 Skill 的标准化和兼容性

### 10.2 业务风险
- **业务知识配置复杂度**：客户可能难以准确配置业务规范
- **定位准确率**：初期可能存在误判
- **用户接受度**：需要培养用户信任

### 10.3 应对措施
- 提供详细的 Skill 配置文档和示例
- 建立反馈机制，持续优化定位准确率
- 提供置信度评分，让用户了解结果可信度
- 支持人工介入和修正

---

## 11. 成功指标

### 11.1 产品指标
- 问题定位准确率：> 80%
- 平均定位时间：< 5 分钟
- 用户满意度：> 4.0/5.0

### 11.2 业务指标
- 活跃租户数：> 10
- 月活跃用户数：> 100
- 问题定位次数：> 1000/月

### 11.3 技术指标
- 系统响应时间：P95 < 30s
- 系统可用性：> 99.5%
- API 错误率：< 1%

---

## 12. 附录

### 12.1 术语表
- **Agent**: 基于 LLM 的智能代理，能够自主执行任务
- **Skill**: 封装业务知识和定位流程的扩展包
- **MCP**: Model Context Protocol，用于集成外部工具的协议
- **根因**: 问题的根本原因

### 12.2 参考资料
- Coding Agent 架构设计
- MCP 协议规范
- OpenAI API 文档

---

**文档维护**
- 负责人：[待定]
- 最后更新：2026-02-10
- 下次评审：[待定]
