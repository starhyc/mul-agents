# 产品需求文档（PRD）
# 通用 Agent 框架 + 智能问题定位系统

**版本**: v1.0
**日期**: 2026-02-10
**状态**: MVP 规划

---

## 1. 产品概述

### 1.1 产品定位
构建一个**支持多种执行模式的通用 Agent 框架**，支持不同场景选择适合的 Agent 协作模式。首个应用场景为**微服务分布式架构下的智能问题定位工具**，展示框架的 Hierarchical 多 Agent 协作能力。

### 1.2 核心价值
- **自动化问题定位流程**：将当前需要人工在多个模块间跳转的定位过程自动化
- **业务逻辑异常识别**：能够定位没有报错日志的业务逻辑问题
- **可扩展框架**：支持未来集成其他工具和应用场景
- **业务知识可配置**：客户可上传业务规范，系统自动适配不同业务场景

### 1.3 解决的痛点
- 微服务架构下问题定位需要跨多个服务和模块
- 业务逻辑异常难以通过日志直接发现
- 定位过程依赖人工经验，效率低下
- 不同业务场景需要不同的定位策略

---

## 2. 目标用户

### 2.1 用户角色
- **开发人员**：定位开发环境和测试环境问题
- **运维/SRE**：定位生产环境问题，保障系统稳定性
- **技术支持/客服**：处理客户反馈的问题，快速响应

### 2.2 用户特征
- 熟悉微服务架构和分布式系统
- 需要频繁进行问题定位和故障排查
- 希望提高问题定位效率，减少人工成本

---

## 3. 核心功能

### 3.1 通用 Agent 框架

#### 3.1.1 Agent 执行模式体系

框架支持多种 Agent 执行模式，适配不同场景需求：

**Direct Execution（直接执行）**
- 单个 Agent 直接完成任务
- 适用于：简单任务、明确指令

**Plan-Execute（规划执行）**
- Plan Agent 分析任务、制定计划
- Execution Agents 按计划执行
- 适用于：代码重构、功能开发、需要用户审批的变更

**ReAct（推理-行动循环）**
- Agent 循环执行"推理→行动→观察"
- 根据中间结果动态调整策略
- 适用于：需要动态调整的复杂任务

**Hierarchical（层级协作）**
- 主 Agent 理解任务、动态调度子 Agent
- 子 Agent 可以继续调度孙 Agent，形成执行树
- 适用于：复杂多步骤任务、需要多专业能力协作

**执行模式决策机制**：
- Agent 定义 `supported_modes` 和 `default_mode`
- 父 Agent 调度时可显式指定子 Agent 执行模式（优先级最高）
- 子 Agent 可根据任务特征自主选择执行模式
- 支持运行时模式切换

#### 3.1.2 Agent 交互模式
- **混合式交互**：
  - Agent 自动执行大部分定位步骤
  - 关键决策点询问用户确认：
    - **Bash 命令执行前**：按命令类型分类确认（读操作/写操作/系统命令）
    - **主要流程阶段结束**：日志分析完成、代码分析完成、根因定位完成等
    - **高风险操作**：修改配置、重启服务、数据变更等
  - 用户可配置是否需要询问（自动化程度可调）

#### 3.1.3 执行模式路由矩阵

为降低执行模式选择的随机性，系统需要基于任务特征进行模式路由：

| 任务特征 | 推荐模式 | 触发条件（示例） | 备注 |
|---------|---------|----------------|------|
| 任务边界清晰、步骤少 | Direct Execution | 单服务、单问题、无需多轮推理 | 默认最低成本路径 |
| 任务需要先拆解再执行 | Plan-Execute | 预计步骤 ≥ 3、涉及变更建议输出 | 支持关键节点人工审批 |
| 中间结果不确定，需动态试探 | ReAct | 日志信息不完整、需多次工具迭代 | 按观察结果滚动修正策略 |
| 涉及多域协作、需并行调查 | Hierarchical | 跨服务链路、需多个 Specialist 协同 | 由 Orchestrator 统一汇总证据 |

**模式选择优先级**：
1. 用户或父 Agent 显式指定模式（最高优先级）
2. 路由矩阵自动推荐模式
3. 使用 Agent 的 `default_mode` 兜底

**降级与切换策略**：
- ReAct 连续 N 次迭代无有效增量时，切换为 Plan-Execute 并请求用户确认是否继续
- Hierarchical 在子 Agent 失败率超阈值时，降级为 Direct 或 Plan-Execute 的最小可行路径
- 任意模式在触发高风险操作前，统一进入交互确认流程

#### 3.1.4 工具扩展机制
采用三层工具体系：

**层级 1：内置工具（Python 实现）**
- 日志分析工具
- 代码搜索工具
- 文件读写工具
- 基础 Shell 执行工具

**层级 2：MCP 扩展**
- 外部系统集成（监控系统、日志平台、数据库等）
- 第三方服务调用
- 客户自定义工具

**层级 3：Skill 扩展**
- 业务规范文档
- 特定场景的定位流程
- 领域知识库
- **沙盒执行**：Skill 代码在隔离环境中运行，限制文件系统和网络访问

#### 3.1.5 LLM 接口
- 支持 OpenAI compatible 通用接口
- 客户可自行添加和配置多个 LLM 模型
- 支持模型切换和选择

#### 3.1.6 交互风险分级与确认策略

系统按操作风险进行分级，并映射默认交互策略：

| 风险等级 | 操作类型示例 | 默认策略 | 可配置项 |
|---------|-------------|---------|---------|
| R0（只读低风险） | 日志检索、代码搜索、历史记录查询 | 自动执行 | 是否在时间线中展示完整参数 |
| R1（受控写操作） | 生成修复建议草案、创建工单草稿 | 一次确认 | 按角色放行（管理员/普通用户） |
| R2（高风险变更） | 修改配置文件、执行写入型脚本 | 二次确认 + 原因说明 | 是否要求管理员审批 |
| R3（系统级危险操作） | 重启服务、数据删除/回滚 | 强制管理员确认 + 审计记录 | 可在生产环境禁用 |

**确认机制要求**：
- 每次确认需展示：操作目的、影响范围、回滚方案、预估风险
- 用户可配置自动化级别（保守/平衡/激进），映射不同风险等级的默认放行阈值
- 所有 R2/R3 操作必须记录审计日志并关联当前诊断会话

#### 3.1.7 故障处理机制
- **重试机制**：
  - LLM 调用失败自动重试（可配置次数和间隔）
  - 工具调用失败重试
  - Agent 执行失败可重新启动整个流程
- **超时控制**：
  - 单个工具调用超时限制
  - 单个 Agent 执行超时限制
  - 整体诊断流程超时限制
- **失败恢复**：
  - 保存 Agent 执行状态，支持从失败点恢复
  - 用户可选择重试失败的 Agent 或跳过继续

#### 3.1.8 任务状态机与断点恢复

系统采用统一任务状态机管理诊断流程：

`queued → running → waiting_user → retrying → completed / failed / canceled`

**状态定义**：
- `queued`：任务已创建，等待调度资源
- `running`：Agent 正在执行推理或工具调用
- `waiting_user`：等待用户确认高风险操作或关键决策
- `retrying`：出现可恢复错误，正在按策略重试
- `completed`：任务完成并输出诊断报告
- `failed`：超出重试上限或遇到不可恢复错误
- `canceled`：用户主动终止

**断点恢复要求**：
- 以 Agent 节点为最小恢复粒度，持久化输入上下文、工具调用结果与中间结论
- 恢复时优先复用已验证证据，避免重复调用高成本工具
- 对写操作工具引入幂等键，防止重试导致重复副作用

### 3.2 问题定位能力

#### 3.2.1 支持的问题类型
- 业务逻辑异常（无报错日志）
- 系统报错和异常
- 性能问题（接口响应慢、资源占用高）
- 数据不一致问题
- 间歇性故障

#### 3.2.2 动态定位策略

问题定位采用 **Hierarchical + ReAct 混合模式**：

**主 Agent（Orchestrator）**：
- 理解问题描述和上下文
- 根据问题类型制定初步策略
- 动态调度专业子 Agent
- 综合子 Agent 结果进行根因分析

**专业子 Agent（Specialists）**：
- 日志分析 Agent
- 代码搜索 Agent
- 链路追踪 Agent
- 业务规范验证 Agent
- 性能分析 Agent
- 等等...

**动态执行示例**：
- 简单报错：主 Agent → 日志分析 Agent → 根因分析
- 业务逻辑异常：主 Agent → 业务规范 Agent → 代码搜索 Agent → 逻辑验证 Agent
- 性能问题：主 Agent → 监控数据 Agent → 慢查询 Agent → 优化建议 Agent
- 复杂问题：主 Agent 根据中间结果动态调整策略，可能多次调用不同 Agent

**注**：不同问题的执行路径完全不同，由主 Agent 根据实际情况动态决策。

#### 3.2.3 业务知识配置
- 客户通过上传 **Skill 压缩包**提供业务信息
- Skill 包内容：
  - 业务规范文档
  - 日志格式说明
  - 服务拓扑关系
  - 业务流程图
  - 其他业务相关文件

#### 3.2.4 输出内容（可配置）
- 问题根因分析
- 涉及的服务和调用链路
- 相关代码位置
- 修复建议
- 置信度评分
- 相似历史问题推荐

#### 3.2.5 诊断过程可视化
- **层级导航树**：
  - 显示父子 Agent 关系（主 Agent → 子 Agent → 孙 Agent）
  - 实时状态显示（运行中/已完成/失败/等待确认）
  - 支持点击展开/折叠查看详情
- **详细时间线视图**：
  - LLM 推理步骤和输出
  - 工具调用记录（参数、返回值、耗时）
  - 子 Agent 调度和执行过程
  - 用户交互确认点
- **核心指标面板**：
  - 当前状态（运行中/已完成/失败）
  - 总耗时和各阶段耗时
  - 输入 Token 数和输出 Token 数
  - 预估成本（基于 Token 使用量）
  - 调用的 LLM 模型信息

### 3.3 用户管理（单租户）

#### 3.3.1 用户权限
- 管理员：管理系统配置、用户权限、Skill/MCP/LLM 配置
- 普通用户：使用问题定位功能、查看历史记录
- 只读用户：仅查看历史记录和报告

**注**：MVP 版本为内部使用，采用单租户架构。多租户支持将在后续版本中实现。

### 3.4 历史记录与知识库

#### 3.4.1 历史定位记录
- 保存每次问题定位的完整过程
- 包含输入、分析步骤、输出结果、完整的 Agent 执行树
- 支持按时间、问题类型、服务等维度检索
- 可重放诊断过程（查看完整时间线和 Agent 调用关系）

#### 3.4.2 知识库积累
- 手动添加已知问题和解决方案
- 相似问题推荐（基于问题描述和特征匹配）
- 问题模式识别（后续版本支持自动学习）

---

## 4. 用户场景

### 4.1 场景 1：用户反馈功能异常
**场景描述**：用户反馈"订单提交失败"

**定位流程**：
1. 用户输入问题描述："用户 A 在 2026-02-10 10:30 提交订单失败"
2. Agent 自动收集相关日志（订单服务、支付服务、库存服务）
3. Agent 分析调用链路，发现库存服务返回异常
4. Agent 定位到库存服务代码，发现库存扣减逻辑错误
5. Agent 输出根因：库存扣减时未考虑并发场景，导致超卖
6. Agent 提供修复建议：添加分布式锁或使用数据库乐观锁

### 4.2 场景 2：性能问题定位
**场景描述**：某接口响应时间突然变慢

**定位流程**：
1. 用户输入："订单查询接口响应时间从 100ms 增加到 3s"
2. Agent 分析监控数据，发现数据库查询耗时增加
3. Agent 检查数据库慢查询日志
4. Agent 定位到未添加索引的查询语句
5. Agent 输出根因和优化建议

### 4.3 场景 3：业务逻辑异常
**场景描述**：优惠券计算结果不符合预期

**定位流程**：
1. 用户输入："用户 B 使用优惠券后价格计算错误"
2. Agent 读取业务规范（从 Skill 中获取优惠券计算规则）
3. Agent 分析相关代码和日志
4. Agent 发现优惠券叠加逻辑与业务规范不一致
5. Agent 输出根因和修复建议

---

## 5. 功能需求

### 5.1 Agent 框架核心功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| Agent 引擎 | 基于 LLM 的推理和决策引擎 | P0 |
| 执行模式管理 | 支持多种执行模式、模式选择和切换 | P0 |
| 工具注册 | 支持内置工具、MCP、Skill 的注册和调用 | P0 |
| 交互控制 | 支持自动执行和询问用户的混合模式 | P0 |
| LLM 管理 | 支持多 LLM 配置和切换 | P0 |
| 上下文管理 | 管理对话上下文和工具调用历史 | P0 |
| 故障处理 | 重试机制、超时控制、失败恢复 | P0 |
| Skill 沙盒 | Skill 代码隔离执行环境 | P0 |

### 5.2 问题定位功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 日志分析 | 解析和分析各类日志格式 | P0 |
| 代码搜索 | 在代码库中搜索相关代码 | P0 |
| 调用链追踪 | 分析服务间调用关系 | P1 |
| 根因分析 | 基于日志和代码推断问题根因 | P0 |
| 修复建议 | 提供可行的修复方案 | P1 |
| 业务规范匹配 | 根据业务规范验证逻辑正确性 | P1 |

### 5.3 系统管理功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 用户管理 | 用户注册、登录、权限管理（单租户） | P0 |
| Skill 管理 | 上传、解析、管理 Skill 压缩包 | P0 |
| MCP 管理 | 配置和管理 MCP 服务器 | P1 |
| LLM 配置 | 配置和管理 LLM 接口 | P0 |
| 历史记录 | 查看和检索历史定位记录 | P0 |
| 知识库 | 手动管理已知问题和解决方案 | P1 |

### 5.4 Web 界面功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 问题定位界面 | 输入问题描述，展示定位过程和结果 | P0 |
| 诊断过程可视化 | 层级导航树、详细时间线、核心指标面板 | P0 |
| 配置管理界面 | 管理 Skill、MCP、LLM 配置 | P0 |
| 历史记录界面 | 查看和检索历史记录，支持重放 | P0 |
| 知识库界面 | 浏览和管理已知问题 | P1 |
| 系统设置界面 | 用户管理和系统配置 | P0 |

---

## 6. 非功能需求

### 6.1 性能要求
- 单次问题定位响应时间：< 30 秒（简单问题）
- 并发支持：支持 100+ 并发用户
- 历史记录查询：< 1 秒

### 6.2 可用性要求
- 系统可用性：99.5%
- 支持水平扩展

### 6.3 安全要求
- 用户认证和授权
- 敏感信息加密存储
- API 访问控制
- Skill 代码沙盒隔离执行

### 6.4 可扩展性要求
- 支持动态加载 Skill 和 MCP
- 支持添加新的内置工具
- 支持多种 LLM 模型

### 6.5 易用性要求
- 界面简洁直观
- 问题定位过程可视化
- 支持自然语言输入
